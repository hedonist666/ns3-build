name: Build Release
on: [ push, pull_request ]
jobs:
  create-release:
    runs-on: 'ubuntu-22.04'
    outputs:
      upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create-release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: ncipollo/release-action@v1
        with:
          omitBody: true
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
  build:
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-22.04 ]
        platform:
          - 'linux-x64'
          - 'linux-armv6'
          - 'linux-armv7'
        include:
          - os: macos-11
            platform: 'darwin-x64'
          - os: macos-11
            platform: 'darwin-arm64v8'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install advancecomp automake brotli nasm pkg-config cartr/qt4/qt-legacy-formula bzr rar p7zip xz cMake
          curl -O https://distfiles.macports.org/MacPorts/MacPorts-2.7.2.tar.bz2
          tar xf MacPorts-2.7.2.tar.bz2
          cd MacPorts-2.7.2/
          ./configure
          make
          sudo make install
          cd ..
      - name: Build ${{ matrix.platform }}
        id: build-release
        run: ./build.sh 3.29 ${{ matrix.platform }}
      - name: Upload Release Asset (.tar.gz)
        id: upload-release-asset-gz
        if: startsWith(github.ref, 'refs/tags/v')
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: ${{ matrix.platform }}.tar.gz
          artifactContentType: application/gzip
          artifactErrorsFailBuild: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
